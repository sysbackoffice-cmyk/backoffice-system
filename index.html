<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management System - SHAKIR AMMAR</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --bg: #0f101a; --card-bg: rgba(255, 255, 255, 0.03); --blue: #00d2ff; --purple: #a29bfe; --orange: #ff9f43; --danger: #ff4b5c; --green: #55efc4; --yellow: #fff200; --text-gray: #94a3b8; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', Tahoma, sans-serif; display: flex; flex-direction: column; min-height: 100vh; align-items: center; }
        
        /* شريط المعلومات العلوي */
        .top-info-bar { width: 100%; background: rgba(255,255,255,0.02); padding: 10px 0; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: center; gap: 30px; font-size: 0.95rem; }
        .live-time { color: var(--blue); font-weight: bold; }

        /* شريط التنقل */
        .nav-bar { width: 100%; background: rgba(0,0,0,0.4); padding: 15px 0; display: flex; justify-content: center; gap: 10px; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .nav-link { padding: 10px 25px; border-radius: 50px; cursor: pointer; font-weight: 800; color: var(--text-gray); transition: 0.3s; font-size: 0.85rem; }
        .nav-link.active-lunch { background: var(--blue); color: black; }
        .nav-link.active-leaves { background: var(--orange); color: black; }
        .nav-link.active-task { background: var(--purple); color: black; }

        .user-badge.already-booked { opacity: 0.3; cursor: not-allowed; background: #444 !important; color: #888 !important; box-shadow: none; }

        .admin-controls { display: none; width: 100%; background: rgba(255, 75, 92, 0.1); padding: 12px 0; text-align: center; border-bottom: 1px solid var(--danger); }
        .admin-mode .admin-controls { display: block; }
        .admin-btn { background: white; border: none; padding: 6px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; margin: 0 5px; font-size: 0.8rem; }

        .container { width: 95%; max-width: 1200px; display: none; padding: 30px 0; margin: 0 auto; align-items: center; text-align: center; }
        .container.active { display: flex; flex-direction: column; }

        .emp-list-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 35px; width: 100%; }
        .user-badge { background: #fff; color: #000; padding: 10px 18px; border-radius: 12px; font-weight: 700; font-size: 0.95rem; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 2px solid transparent; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; width: 100%; justify-content: center; }

        .card { background: var(--card-bg); border-radius: 20px; padding: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.08); display: flex; flex-direction: column; min-height: 180px; align-items: center; justify-content: space-between; transition: 0.3s; }
        .card:hover { border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); }

        .reserve-btn { border: none; padding: 12px 25px; border-radius: 12px; font-weight: 800; cursor: pointer; font-size: 0.85rem; transition: 0.3s; width: 90%; margin-top: 15px; }
        .btn-lunch { background: linear-gradient(135deg, var(--blue), #00a8cc); color: black; }
        .btn-leaves { background: linear-gradient(135deg, var(--orange), #e67e22); color: black; }

        /* تعديلات جدول المهام (Task Table) للوضوح التام */
        .table-wrapper { width: 100%; background: #161b22; border-radius: 20px; overflow-x: auto; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        
        /* العناوين المحددة التي طلبتها */
        th { 
            background: rgba(255,255,255,0.05); 
            padding: 22px 15px; 
            font-size: 1.1rem; /* تكبير الخط */
            font-weight: 900; /* جعل الخط عريض جداً */
            color: #ffffff; /* لون أبيض ناصع */
            text-transform: uppercase; 
            letter-spacing: 2px; /* مسافات بين الحروف للوضوح */
            border-bottom: 2px solid var(--purple); /* خط سفلي مميز تحت العناوين */
        }
        
        td { padding: 18px 15px; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 1rem; }
        
        .task-badge { padding: 8px 16px; border-radius: 10px; font-weight: 800; font-size: 0.85rem; display: inline-block; }
        .badge-esc { background: rgba(0, 210, 255, 0.15); color: var(--blue); border: 1px solid rgba(0, 210, 255, 0.3); }
        .badge-feed { background: rgba(162, 155, 254, 0.15); color: var(--purple); border: 1px solid rgba(162, 155, 254, 0.3); }
        .badge-back { background: rgba(255, 242, 0, 0.15); color: var(--yellow); border: 1px solid rgba(255, 242, 0, 0.3); }
        
        tr.today-row { background: rgba(85, 239, 196, 0.12) !important; border-right: 6px solid var(--green); }

        .footer-signature { margin-top: auto; padding: 60px 0; width: 100%; text-align: center; border-top: 1px solid rgba(255,255,255,0.03); }
        .signature-name { font-size: 1.6rem; font-weight: 900; letter-spacing: 8px; font-family: 'Times New Roman', serif; color: #fff; }
        .signature-sub { font-size: 0.7rem; color: var(--text-gray); margin-top: 5px; letter-spacing: 2px; }

        .remove-x { color: var(--danger); margin-right: 8px; cursor: pointer; display: none; }
        .admin-mode .remove-x { display: inline; }
    </style>
</head>
<body>

    <div class="top-info-bar">
        <span id="liveDate">--/--/----</span>
        <span id="liveClock" class="live-time">00:00:00</span>
    </div>

    <nav class="nav-bar">
        <div id="btnLunch" class="nav-link active-lunch" onclick="tab('lunch')">LUNCH</div>
        <div id="btnLeaves" class="nav-link" onclick="tab('leaves')">LEAVES</div>
        <div id="btnTask" class="nav-link" onclick="tab('task')">TASK</div>
    </nav>

    <div class="admin-controls">
        <button class="admin-btn" onclick="setCap(1)">SEAT 1</button>
        <button class="admin-btn" onclick="setCap(2)">SEAT 2</button>
        <button class="admin-btn" style="background:var(--danger); color:white" onclick="resetTasksOnly()">RESET TABLE</button>
        <label class="admin-btn" style="background:var(--green); cursor:pointer">Upload XLSX<input type="file" id="excelInput" style="display:none" onchange="handleTaskFile(this)"></label>
        <button class="admin-btn" onclick="document.body.classList.remove('admin-mode')">EXIT ADMIN</button>
    </div>

    <div id="lunchSection" class="container active"><div id="lunchEmpList" class="emp-list-container"></div><div id="lunchGrid" class="grid"></div></div>
    <div id="leavesSection" class="container"><div id="leavesEmpList" class="emp-list-container"></div><div id="leavesGrid" class="grid"></div></div>
    
    <div id="taskSection" class="container">
        <div id="taskOffSection" style="margin-bottom: 25px; width: 100%; max-width: 600px; background: rgba(255, 75, 92, 0.08); padding: 15px; border-radius: 15px; display:none; border: 1px solid rgba(255,75,92,0.2);">
            <span style="color:var(--danger); font-weight:bold;">OFF DUTY TODAY ⛔</span>
            <div id="taskOffBadges" style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:10px;"></div>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Escalation</th>
                        <th>Feedback</th>
                        <th>Backup</th>
                    </tr>
                </thead>
                <tbody id="taskTableBody"></tbody>
            </table>
        </div>
    </div>

    <footer class="footer-signature">
        <div class="signature-name">SHAKIR AMMAR</div>
        <div class="signature-sub">MANAGEMENT SYSTEM PRO</div>
        <div onclick="adminMode()" style="opacity:0.02; cursor:pointer; font-size: 0.6rem; margin-top: 15px;">SYSTEM ADMIN</div>
    </footer>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAK7BESJWRaFk021ZNcUT2Lx4Qi2Tc0GRI",
      authDomain: "managementsystembackoffice.firebaseapp.com",
      databaseURL: "https://managementsystembackoffice-default-rtdb.firebaseio.com",
      projectId: "managementsystembackoffice",
      storageBucket: "managementsystembackoffice.firebasestorage.app",
      messagingSenderId: "1099425828111",
      appId: "1:1099425828111:web:44651d657afd9ba337c27a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const employees = ["Muhammad", "Riyam", "Zahraa", "Ibrahem", "Hasan", "Zaynab", "Narjes", "Sajjad", "Shakir", "Abid Allah Najm", "Abid Allah"];
    const lunchTimes = ["01:00", "01:30", "02:00", "02:30", "03:00", "03:20"];
    let lunchData = {}, leavesData = {}, taskHistory = null, maxCap = 1, selectedEmp = null;

    db.ref('/').on('value', (snap) => {
        const d = snap.val() || {};
        lunchData = d.lunchData || {}; 
        leavesData = d.leavesData || {}; 
        taskHistory = d.taskHistory || null; 
        maxCap = d.maxCap || 1;
        render(); 
        if(taskHistory) processTaskData(taskHistory);
    });

    function forceResetCheck() {
        const now = new Date();
        const dateKey = now.toLocaleDateString('en-CA');
        const hour = now.getHours();
        db.ref('lastResetDate').get().then((snapshot) => {
            if (snapshot.val() !== dateKey && hour >= 8) {
                db.ref('lunchData').set({});
                db.ref('lastResetDate').set(dateKey);
            }
        });
    }
    forceResetCheck();

    function tab(t) {
        selectedEmp = null;
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => l.className = 'nav-link');
        document.getElementById(t+'Section').classList.add('active');
        document.getElementById('btn'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active-'+t);
        render();
    }

    function render() {
        const activeContainer = document.querySelector('.container.active');
        if(!activeContainer || activeContainer.id === 'taskSection') return;
        const activeTab = activeContainer.id.replace('Section', '');
        
        let bookedUsers = [];
        if(activeTab === 'lunch') {
            for(let time in lunchData) {
                if(Array.isArray(lunchData[time])) bookedUsers = bookedUsers.concat(lunchData[time]);
            }
        }

        const listDiv = document.getElementById(activeTab + 'EmpList');
        listDiv.innerHTML = '';
        employees.forEach(name => {
            const div = document.createElement('div');
            div.className = 'user-badge';
            if(activeTab === 'lunch' && bookedUsers.includes(name)) div.classList.add('already-booked');
            if(selectedEmp === name) { 
                div.style.background = activeTab==='lunch'?'var(--blue)':'var(--orange)'; 
                div.style.color = 'black'; 
            }
            div.innerText = name; 
            div.onclick = () => { 
                if(!div.classList.contains('already-booked')) {
                    selectedEmp = name; 
                    render(); 
                }
            };
            listDiv.appendChild(div);
        });

        const grid = document.getElementById(activeTab + 'Grid');
        grid.innerHTML = '';

        if(activeTab === 'lunch') {
            lunchTimes.forEach(t => {
                const card = document.createElement('div'); card.className = 'card';
                const usersArr = Array.isArray(lunchData[t]) ? lunchData[t] : [];
                const usersHtml = usersArr.filter(n => n).map(n => `<div class="user-badge" style="font-size:0.8rem; padding:4px 10px; margin:2px;"><span class="remove-x" onclick="cancelL('${t}','${n}')">✕</span>${n}</div>`).join('');
                const left = maxCap - usersArr.length;
                card.innerHTML = `<div><h3>${t}</h3><small style="color:var(--text-gray)">Available Seats: ${left}</small></div><div style="margin:10px 0; display:flex; flex-wrap:wrap; justify-content:center;">${usersHtml}</div><button class="reserve-btn btn-lunch" ${!selectedEmp || left <= 0 ?'disabled':''} onclick="bookL('${t}')">RESERVE SEAT</button>`;
                grid.appendChild(card);
            });
        } else if(activeTab === 'leaves') {
            getNext10Days().forEach(d => {
                const card = document.createElement('div'); card.className = 'card';
                const usersArr = Array.isArray(leavesData[d.id]) ? leavesData[d.id] : [];
                const usersHtml = usersArr.filter(n => n).map(n => `<div class="user-badge" style="font-size:0.85rem; padding:6px 12px; margin:3px;"><span class="remove-x" onclick="cancelV('${d.id}','${n}')">✕</span>${n}</div>`).join('');
                card.innerHTML = `<div><h3 style="margin:0">${d.dayName}</h3><small style="color:var(--orange); font-weight:bold;">${d.dateStr}</small></div><div style="margin:15px 0; display:flex; flex-wrap:wrap; justify-content:center;">${usersHtml}</div><button class="reserve-btn btn-leaves" ${!selectedEmp ? 'disabled':''} onclick="bookV('${d.id}')">REQUEST OFF</button>`;
                grid.appendChild(card);
            });
        }
    }

    function bookL(t) {
        if(!selectedEmp) return;
        let l = Array.isArray(lunchData[t]) ? lunchData[t] : [];
        l.push(selectedEmp);
        db.ref('lunchData/'+t).set(l);
        selectedEmp = null;
    }

    function bookV(id) {
        if(!selectedEmp) return;
        let l = Array.isArray(leavesData[id]) ? leavesData[id] : [];
        if(!l.includes(selectedEmp)) {
            l.push(selectedEmp);
            db.ref('leavesData/'+id).set(l);
        }
        selectedEmp = null;
    }

    function cancelL(t,n) { if(Array.isArray(lunchData[t])) db.ref('lunchData/'+t).set(lunchData[t].filter(x=>x!==n)); }
    function cancelV(id,n) { if(Array.isArray(leavesData[id])) db.ref('leavesData/'+id).set(leavesData[id].filter(x=>x!==n)); }

    function getNext10Days() {
        let days=[];
        for(let i=1; i<=10; i++){
            let d = new Date(); d.setDate(d.getDate()+i);
            days.push({ id: d.toISOString().split('T')[0], dateStr: d.toLocaleDateString('en-GB',{day:'numeric', month:'short'}), dayName: d.toLocaleDateString('en-GB',{weekday:'long'}) });
        }
        return days;
    }

    function handleTaskFile(input) {
        if(!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type:'array', cellDates:true});
                const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});
                let startIdx = rows.findIndex(r => r[1] && !isNaN(Date.parse(r[1])));
                const tasks = rows.slice(startIdx).map(r => {
                    if (!r[1] || isNaN(Date.parse(r[1]))) return null;
                    let d = new Date(r[1]);
                    return { 
                        date: d.getFullYear() + "-" + (d.getMonth()+1) + "-" + d.getDate(), 
                        off: [r[2], r[3], r[4], r[5]].filter(v => v && v !== "-" && v !== "0" && v.toString().trim() !== ""), 
                        email: r[6] || "-", feed: r[7] || "-", back: r[8] || "-" 
                    };
                }).filter(x => x !== null && x.date.includes("-"));
                db.ref('taskHistory').set(tasks).then(() => { alert("Updated Successfully!"); tab('task'); });
            } catch (err) { alert("Error reading file!"); }
        };
        reader.readAsArrayBuffer(input.files[0]);
    }

    function processTaskData(data) {
        const body = document.getElementById('taskTableBody');
        const offSec = document.getElementById('taskOffSection');
        const offB = document.getElementById('taskOffBadges');
        body.innerHTML = ''; offB.innerHTML = ''; offSec.style.display = 'none';
        const todayStr = new Date().getFullYear() + "-" + (new Date().getMonth()+1) + "-" + new Date().getDate();
        const rows = (Array.isArray(data) ? data : Object.values(data)).filter(r => r && r.date);
        rows.forEach(row => {
            const isToday = row.date === todayStr;
            if(isToday && row.off && row.off.length > 0) {
                offSec.style.display = 'block';
                row.off.forEach(name => {
                    const b = document.createElement('div');
                    b.className = "user-badge"; b.style.cssText = "background:var(--danger); color:white; border:none; font-size:0.8rem; padding:5px 12px;";
                    b.innerText = name; offB.appendChild(b);
                });
            }
            const tr = document.createElement('tr');
            if(isToday) tr.className = 'today-row';
            const dObj = new Date(row.date);
            tr.innerHTML = `<td><b>${dObj.toLocaleDateString('en-GB',{weekday:'short'})}</b><br><small>${dObj.getDate()}/${dObj.getMonth()+1}</small></td><td><span class="task-badge badge-esc">${row.email}</span></td><td><span class="task-badge badge-feed">${row.feed}</span></td><td><span class="task-badge badge-back">${row.back}</span></td>`;
            body.appendChild(tr);
        });
    }

    function resetTasksOnly() { if(confirm("Reset Table?")) db.ref('taskHistory').remove(); }
    function setCap(n) { db.ref('maxCap').set(n); }
    function adminMode() { if(prompt("Password:") === "8808") document.body.classList.add('admin-mode'); }
    
    setInterval(() => {
        const n = new Date();
        document.getElementById('liveClock').innerText = n.toLocaleTimeString('en-GB');
        document.getElementById('liveDate').innerText = n.toLocaleDateString('en-GB', {weekday:'long', day:'numeric', month:'long'});
    }, 1000);
</script>
</body>
</html>
